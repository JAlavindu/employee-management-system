<div class="page-container">
  <div class="header-actions">
    <h2>Employee Management</h2>
    <button class="btn-new" (click)="openModal()">+ New Employee</button>
  </div>

  <!-- Search Component -->
  <app-search-component ></app-search-component>

  <!-- Employee Table -->
  <app-employee-view-table-component [filteredEmployees]="filteredEmployees" (viewEmployee)="onView($event)"></app-employee-view-table-component>

  <!-- Reusable Form Fields Template -->
  <ng-template #formFields>
    <div class="form-grid" [formGroup]="employeeForm">
      <!-- Employee Code -->
      <div class="form-group">
        <label>Employee Code</label>
        <input
          type="text"
          formControlName="employeeCode"
          class="form-control"
          [class.is-invalid]="
            employeeForm.get('employeeCode')?.invalid && employeeForm.get('employeeCode')?.touched
          "
        />

        <div
          *ngIf="
            employeeForm.get('employeeCode')?.invalid && employeeForm.get('employeeCode')?.touched
          "
        >
          <small class="error-text" *ngIf="employeeForm.get('employeeCode')?.errors?.['required']">
            Employee Code is required.
          </small>
          <small class="error-text" *ngIf="employeeForm.get('employeeCode')?.errors?.['pattern']">
            Format must be 'EMP' followed by 3 digits (e.g., EMP001).
          </small>
        </div>
      </div>

      <!-- Status -->
      <div class="form-group">
        <label>Status</label>
        <select formControlName="status">
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
        </select>
      </div>

      <!-- First Name -->
      <div class="form-group">
        <label>First Name</label>
        <input
          type="text"
          formControlName="firstName"
          class="form-control"
          [class.is-invalid]="
            employeeForm.get('firstName')?.invalid && employeeForm.get('firstName')?.touched
          "
        />

        <div
          *ngIf="employeeForm.get('firstName')?.invalid && employeeForm.get('firstName')?.touched"
        >
          <small class="error-text" *ngIf="employeeForm.get('firstName')?.errors?.['required']">
            First Name is required.
          </small>
          <small class="error-text" *ngIf="employeeForm.get('firstName')?.errors?.['pattern']">
            Only letters and spaces are allowed (no numbers).
          </small>
        </div>
      </div>

      <!-- Last Name -->
      <div class="form-group">
        <label>Last Name</label>
        <input
          type="text"
          formControlName="lastName"
          class="form-control"
          [class.is-invalid]="
            employeeForm.get('lastName')?.invalid && employeeForm.get('lastName')?.touched
          "
        />

        <div *ngIf="employeeForm.get('lastName')?.invalid && employeeForm.get('lastName')?.touched">
          <small class="error-text" *ngIf="employeeForm.get('lastName')?.errors?.['required']">
            Last Name is required.
          </small>
          <small class="error-text" *ngIf="employeeForm.get('lastName')?.errors?.['pattern']">
            Only letters and spaces are allowed (no numbers).
          </small>
        </div>
      </div>

      <!-- NIC -->
      <div class="form-group">
        <label>NIC</label>
        <input
          type="text"
          formControlName="nic"
          class="form-control"
          [class.is-invalid]="employeeForm.get('nic')?.invalid && employeeForm.get('nic')?.touched"
        />

        <div *ngIf="employeeForm.get('nic')?.invalid && employeeForm.get('nic')?.touched">
          <small class="error-text" *ngIf="employeeForm.get('nic')?.errors?.['required']">
            NIC is required.
          </small>
          <small class="error-text" *ngIf="employeeForm.get('nic')?.errors?.['pattern']">
            Must be 9 digits + V/X (e.g., 123456789V) or 12 digits.
          </small>
        </div>
      </div>

      <!-- Mobile No -->
      <div class="form-group">
        <label>Mobile No</label>
        <input
          type="text"
          formControlName="mobileNo"
          class="form-control"
          [class.is-invalid]="
            employeeForm.get('mobileNo')?.invalid && employeeForm.get('mobileNo')?.touched
          "
        />

        <div *ngIf="employeeForm.get('mobileNo')?.invalid && employeeForm.get('mobileNo')?.touched">
          <small class="error-text" *ngIf="employeeForm.get('mobileNo')?.errors?.['required']">
            Mobile Number is required.
          </small>
          <small class="error-text" *ngIf="employeeForm.get('mobileNo')?.errors?.['pattern']">
            Must start with 07 and contain 10 digits (e.g., 0712345678).
          </small>
        </div>
      </div>

      <div class="form-group">
        <label>Email</label>
        <input
          type="email"
          formControlName="email"
          class="form-control"
          [class.is-invalid]="
            employeeForm.get('email')?.invalid && employeeForm.get('email')?.touched
          "
        />

        <div *ngIf="employeeForm.get('email')?.invalid && employeeForm.get('email')?.touched">
          <small class="error-text" *ngIf="employeeForm.get('email')?.errors?.['required']">
            Email is required.
          </small>
          <small class="error-text" *ngIf="employeeForm.get('email')?.errors?.['email']">
            Please enter a valid email address.
          </small>
        </div>
      </div>

      <!-- Designation -->
      <div class="form-group">
        <label>Designation</label>
        <select
          formControlName="designation"
          class="form-control"
          [class.is-invalid]="
            employeeForm.get('designation')?.invalid && employeeForm.get('designation')?.touched
          "
        >
          <option value="" disabled>Select Designation</option>
          <option *ngFor="let des of designations" [value]="des">{{ des }}</option>
        </select>

        <div
          *ngIf="
            employeeForm.get('designation')?.invalid && employeeForm.get('designation')?.touched
          "
        >
          <small class="error-text" *ngIf="employeeForm.get('designation')?.errors?.['required']">
            Please select a designation.
          </small>
        </div>
      </div>

      <!-- Date of Birth -->
      <div class="form-group">
        <label>Date of Birth</label>
        <input
          type="date"
          formControlName="dob"
          class="form-control"
          [class.is-invalid]="employeeForm.get('dob')?.invalid && employeeForm.get('dob')?.touched"
        />

        <div *ngIf="employeeForm.get('dob')?.invalid && employeeForm.get('dob')?.touched">
          <small class="error-text" *ngIf="employeeForm.get('dob')?.errors?.['required']">
            Date of Birth is required.
          </small>
          <small class="error-text" *ngIf="employeeForm.get('dob')?.errors?.['minimumAge']">
            Employee must be at least 18 years old.
          </small>
        </div>
      </div>

      <!-- Profile Image -->
      <div class="form-group">
        <label>Profile Image</label>
        <input
          type="file"
          (change)="fileChange($event)"
          class="form-control"
          [class.is-invalid]="
            employeeForm.get('profileImage')?.invalid && employeeForm.get('profileImage')?.touched
          "
        />

        <div
          *ngIf="
            employeeForm.get('profileImage')?.invalid && employeeForm.get('profileImage')?.touched
          "
        >
          <small class="error-text" *ngIf="employeeForm.get('profileImage')?.errors?.['required']">
            Profile image is required.
          </small>
        </div>
      </div>

      <!-- Gender (Full Width) -->
      <div class="form-group full-width">
        <label>Gender</label>
        <div class="radio-group">
          <label><input type="radio" value="male" formControlName="gender" /> Male</label>
          <label><input type="radio" value="female" formControlName="gender" /> Female</label>
        </div>
      </div>

      <!-- Address Field -->
      <div class="form-group full-width">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
          "
        >
          <label>Address</label>
          <button
            type="button"
            class="btn-secondary"
            style="padding: 2px 8px; font-size: 0.8rem"
            (click)="toggleMap()"
          >
            <i class="fa fa-map-marker"></i> {{ showMapPicker ? 'Hide Map' : 'Pick on Map' }}
          </button>
        </div>

        <textarea
          formControlName="address"
          class="form-control"
          rows="2"
          [class.is-invalid]="
            employeeForm.get('address')?.invalid && employeeForm.get('address')?.touched
          "
        ></textarea>

        <!-- Map Component Integration -->
        <div *ngIf="showMapPicker">
          <app-map-picker (addressSelected)="onAddressSelected($event)"></app-map-picker>
        </div>

        <div *ngIf="employeeForm.get('address')?.invalid && employeeForm.get('address')?.touched">
          <small class="error-text" *ngIf="employeeForm.get('address')?.errors?.['required']">
            Address is required.
          </small>
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Registration Modal (Existing Code) -->
  <app-registration-modal [isModalOpen]="showModal" (closeModal)="closeModal($event)" [employeeForm]="employeeForm" [callToggleMap]="toggleMap" [showMapPicker]="showMapPicker" [designations]="designations"></app-registration-modal>

  <!-- View/Edit Employee Modal -->
  <app-employee-view-edit-component [showEmployeeViewModal]="showViewModal" [employeeActiveTab]="activeTab" [selectedEmployee]="selectedEmployee" (close)="closeViewModal()" [formFields]="formFields"
    [employeeForm]="employeeForm"
    [fileChange]="fileChange"></app-employee-view-edit-component>
</div>
